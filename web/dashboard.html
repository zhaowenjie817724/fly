<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>通感之眼 · 空地协同</title>
    <style>
      :root {
        --bg: #f2efe9;
        --ink: #0f172a;
        --muted: #6b7280;
        --accent: #0ea5e9;
        --accent-2: #f97316;
        --card: #ffffff;
        --shadow: rgba(15, 23, 42, 0.12);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "LXGW WenKai", "Noto Serif SC", "PingFang SC", "Microsoft YaHei", serif;
        background: radial-gradient(circle at 10% 20%, #ffffff 0%, #f2efe9 40%, #e9e3d9 100%);
        color: var(--ink);
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 32px 20px 60px; }
      header {
        padding: 28px;
        border-radius: 20px;
        background: linear-gradient(120deg, #0f172a 0%, #1f2937 55%, #374151 100%);
        color: #f8fafc;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        position: relative;
        overflow: hidden;
      }
      header::after {
        content: "";
        position: absolute;
        right: -120px;
        top: -120px;
        width: 280px;
        height: 280px;
        border-radius: 50%;
        background: rgba(14, 165, 233, 0.18);
      }
      .title { font-size: 32px; font-weight: 700; letter-spacing: 2px; }
      .subtitle { margin-top: 8px; opacity: 0.75; }
      .status-pill {
        display: inline-block;
        margin-top: 16px;
        padding: 6px 16px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-size: 14px;
      }
      .grid { display: grid; gap: 16px; margin-top: 18px; }
      .grid.two { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
      .grid.three { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 8px 20px var(--shadow);
      }
      .card h3 { margin: 0 0 10px; font-size: 18px; }
      .value {
        font-size: 24px;
        font-weight: 700;
        margin-top: 6px;
      }
      .muted { color: var(--muted); font-size: 14px; }
      .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
      .endpoint input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
      }
      .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
      button {
        border: none;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        background: #111827;
        color: white;
      }
      button.warn { background: #ef4444; }
      button.alt { background: #0ea5e9; }
      .list { max-height: 200px; overflow: auto; }
      .item { padding: 8px 0; border-bottom: 1px dashed #e5e7eb; }
      .item:last-child { border-bottom: none; }
      @media (max-width: 700px) {
        .title { font-size: 26px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title">通感之眼 · 空地协同</div>
        <div class="subtitle">PC 联调仪表盘 · 地面站联通 · 事件流观测</div>
        <div class="status-pill" id="conn-status">未连接</div>
      </header>

      <div class="grid two">
        <div class="card endpoint">
          <h3>联通设置</h3>
          <div class="row"><span class="muted">WS</span></div>
          <input id="ws-input" />
          <div class="row" style="margin-top:10px;"><span class="muted">HTTP</span></div>
          <input id="http-input" />
          <div class="btns">
            <button class="alt" id="btn-connect">重新连接</button>
          </div>
        </div>
        <div class="card">
          <h3>地面站与链路</h3>
          <div class="row"><span class="muted">地面站</span><span id="gcs-label">地面站</span></div>
          <div class="row"><span class="muted">链路状态</span><span id="link-status">未知</span></div>
          <div class="row"><span class="muted">最近更新</span><span id="last-update">-</span></div>
        </div>
      </div>

      <div class="grid three">
        <div class="card">
          <h3>电池</h3>
          <div class="value" id="battery-v">-- V</div>
          <div class="muted" id="battery-pct">剩余 --%</div>
        </div>
        <div class="card">
          <h3>姿态</h3>
          <div class="value" id="attitude">--</div>
          <div class="muted">Roll / Pitch / Yaw</div>
        </div>
        <div class="card">
          <h3>GPS</h3>
          <div class="value" id="gps">--</div>
          <div class="muted" id="alt">高度 -- m</div>
        </div>
      </div>

      <div class="grid two">
        <div class="card">
          <h3>控制台</h3>
          <div class="btns">
            <button id="yaw-left">左转 -10</button>
            <button id="yaw-right">右转 +10</button>
            <button class="alt" id="mode-loiter">悬停</button>
            <button class="warn" id="stop">急停</button>
          </div>
        </div>
        <div class="card">
          <h3>状态提示</h3>
          <div class="muted">建议树莓派 2GB 模式：640x360@10、frame_skip=2、max_fps=5。</div>
        </div>
      </div>

      <div class="grid two">
        <div class="card">
          <h3>事件流</h3>
          <div class="list" id="event-list"></div>
        </div>
        <div class="card">
          <h3>观测流</h3>
          <div class="list" id="obs-list"></div>
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_WS = "ws://127.0.0.1:8000/ws";
      const DEFAULT_HTTP = "http://127.0.0.1:8000/command";
      const wsInput = document.getElementById("ws-input");
      const httpInput = document.getElementById("http-input");
      const statusEl = document.getElementById("conn-status");
      let socket = null;

      function setStatus(connected) {
        statusEl.textContent = connected ? "已连接" : "未连接";
      }

      function renderTelemetry(payload) {
        document.getElementById("battery-v").textContent = payload.battery ? `${payload.battery.voltage_v} V` : "-- V";
        document.getElementById("battery-pct").textContent = payload.battery ? `剩余 ${payload.battery.remaining_pct}%` : "剩余 --%";
        document.getElementById("attitude").textContent = payload.attitude
          ? `${payload.attitude.roll_deg.toFixed(1)}, ${payload.attitude.pitch_deg.toFixed(1)}, ${payload.attitude.yaw_deg.toFixed(1)}`
          : "--";
        document.getElementById("gps").textContent = payload.gps
          ? `${payload.gps.lat.toFixed(5)}, ${payload.gps.lon.toFixed(5)}`
          : "--";
        document.getElementById("alt").textContent = payload.gps ? `高度 ${payload.gps.alt_m.toFixed(1)} m` : "高度 -- m";
      }

      function addListItem(list, title, desc) {
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `<strong>${title}</strong><div class="muted">${desc || ""}</div>`;
        list.prepend(item);
        if (list.children.length > 20) list.removeChild(list.lastChild);
      }

      function connect() {
        if (socket) socket.close();
        const wsUrl = wsInput.value || DEFAULT_WS;
        socket = new WebSocket(wsUrl);
        socket.onopen = () => setStatus(true);
        socket.onclose = () => setStatus(false);
        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === "telemetry") renderTelemetry(data.payload || {});
          if (data.type === "event") addListItem(document.getElementById("event-list"), data.payload.type, data.payload.note);
          if (data.type.startsWith("observation:")) {
            const payload = data.payload || {};
            const desc = payload.bearing_deg != null ? `方位 ${payload.bearing_deg.toFixed(1)}° 置信 ${payload.confidence}` : payload.status;
            addListItem(document.getElementById("obs-list"), payload.source || "unknown", desc);
          }
          if (data.type === "status") {
            const payload = data.payload || {};
            document.getElementById("gcs-label").textContent = payload.gcs_label || "地面站";
            const map = { OK: "正常", DEGRADED: "降级", LOST: "断开", UNKNOWN: "未知" };
            document.getElementById("link-status").textContent = map[payload.link_status] || payload.link_status;
            document.getElementById("last-update").textContent = payload.last_telemetry_epoch_ms
              ? new Date(payload.last_telemetry_epoch_ms).toLocaleTimeString()
              : "-";
          }
        };
      }

      function sendCommand(payload) {
        fetch(httpInput.value || DEFAULT_HTTP, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }

      document.getElementById("btn-connect").addEventListener("click", connect);
      document.getElementById("yaw-left").addEventListener("click", () => sendCommand({ type: "SET_YAW", params: { yaw_deg: -10, duration_ms: 500 } }));
      document.getElementById("yaw-right").addEventListener("click", () => sendCommand({ type: "SET_YAW", params: { yaw_deg: 10, duration_ms: 500 } }));
      document.getElementById("mode-loiter").addEventListener("click", () => sendCommand({ type: "SET_MODE", params: { mode: "LOITER" } }));
      document.getElementById("stop").addEventListener("click", () => sendCommand({ type: "STOP", params: {} }));

      wsInput.value = localStorage.getItem("wsUrl") || DEFAULT_WS;
      httpInput.value = localStorage.getItem("httpUrl") || DEFAULT_HTTP;
      wsInput.addEventListener("change", () => localStorage.setItem("wsUrl", wsInput.value));
      httpInput.addEventListener("change", () => localStorage.setItem("httpUrl", httpInput.value));

      connect();
    </script>
  </body>
</html>
